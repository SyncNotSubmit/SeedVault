<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seed - Knowledge Capsule</title>
<style>
  :root {
    /* Default (Current) Theme */
    --bg-primary: #0a0c0f;
    --bg-secondary: #0f1117;
    --bg-tertiary: #1a1d24;
    --bg-quaternary: #111318;
    --border-primary: #1e2128;
    --border-secondary: #2a2f3a;
    --text-primary: #e2e4e7;
    --text-secondary: #c4c7cc;
    --text-muted: #9ca3af;
    --text-dimmed: #6b7280;
    --text-faint: #4a4f5a;
    --accent: #4ade80;
    --accent-hover: #86efac;
    --accent-bg: rgba(74,222,128,0.05);
    --accent-border: rgba(74,222,128,0.25);
    --scrollbar: #2a2f3a;
  }

  [data-theme="selenized-dark"] {
    --bg-primary: #103c48;
    --bg-secondary: #184956;
    --bg-tertiary: #2d5b69;
    --bg-quaternary: #184956;
    --border-primary: #2d5b69;
    --border-secondary: #4695f7;
    --text-primary: #cad8d9;
    --text-secondary: #adbcbc;
    --text-muted: #72898f;
    --text-dimmed: #4695f7;
    --text-faint: #3d5661;
    --accent: #75b938;
    --accent-hover: #84c747;
    --accent-bg: rgba(117,185,56,0.1);
    --accent-border: rgba(117,185,56,0.3);
    --scrollbar: #4695f7;
  }

  [data-theme="selenized-black"] {
    --bg-primary: #181818;
    --bg-secondary: #252525;
    --bg-tertiary: #3b3b3b;
    --bg-quaternary: #252525;
    --border-primary: #3b3b3b;
    --border-secondary: #368aeb;
    --text-primary: #dedede;
    --text-secondary: #b9b9b9;
    --text-muted: #777777;
    --text-dimmed: #368aeb;
    --text-faint: #4a4a4a;
    --accent: #70b433;
    --accent-hover: #83c746;
    --accent-bg: rgba(112,180,51,0.1);
    --accent-border: rgba(112,180,51,0.3);
    --scrollbar: #368aeb;
  }

  [data-theme="selenized-light"] {
    --bg-primary: #fbf3db;
    --bg-secondary: #ece3cc;
    --bg-tertiary: #d5cdb6;
    --bg-quaternary: #ece3cc;
    --border-primary: #d5cdb6;
    --border-secondary: #0072d4;
    --text-primary: #3a4d53;
    --text-secondary: #53676d;
    --text-muted: #909995;
    --text-dimmed: #0072d4;
    --text-faint: #a8b2b8;
    --accent: #489100;
    --accent-hover: #428b00;
    --accent-bg: rgba(72,145,0,0.1);
    --accent-border: rgba(72,145,0,0.3);
    --scrollbar: #0072d4;
  }

  [data-theme="selenized-white"] {
    --bg-primary: #ffffff;
    --bg-secondary: #ebebeb;
    --bg-tertiary: #cdcdcd;
    --bg-quaternary: #ebebeb;
    --border-primary: #cdcdcd;
    --border-secondary: #0064e4;
    --text-primary: #282828;
    --text-secondary: #474747;
    --text-muted: #878787;
    --text-dimmed: #0064e4;
    --text-faint: #a0a0a0;
    --accent: #1d9700;
    --accent-hover: #008400;
    --accent-bg: rgba(29,151,0,0.1);
    --accent-border: rgba(29,151,0,0.3);
    --scrollbar: #0064e4;
  }

  [data-theme="orange-black"] {
    --bg-primary: #000000;
    --bg-secondary: #1a0f00;
    --bg-tertiary: #2d1f00;
    --bg-quaternary: #1a0f00;
    --border-primary: #4a3000;
    --border-secondary: #ff8c00;
    --text-primary: #ffa500;
    --text-secondary: #ff8c00;
    --text-muted: #cc6600;
    --text-dimmed: #ff8c00;
    --text-faint: #663300;
    --accent: #ff8c00;
    --accent-hover: #ffa500;
    --accent-bg: rgba(255,140,0,0.1);
    --accent-border: rgba(255,140,0,0.3);
    --scrollbar: #ff8c00;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    scrollbar-width: thin;
    scrollbar-color: var(--scrollbar) transparent;
  }
  *::-webkit-scrollbar { width: 4px; }
  *::-webkit-scrollbar-track { background: transparent; }
  *::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 2px; }

  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Courier New', 'Consolas', monospace;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-size: 13px;
    line-height: 1.6;
    overflow: hidden;
  }

  .app {
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    width: 240px;
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-primary);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 20px 16px 12px;
    border-bottom: 1px solid var(--border-primary);
  }

  .logo {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .logo-sub {
    font-size: 10px;
    color: var(--text-faint);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .search-box {
    width: 100%;
    margin-top: 12px;
    padding: 7px 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-secondary);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 12px;
    outline: none;
    transition: border-color 0.15s;
  }

  .search-box:focus {
    border-color: var(--accent);
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
  }

  .collection-group {
    padding: 8px 0;
  }

  .collection-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px 16px;
    cursor: pointer;
    user-select: none;
    transition: all 0.15s;
  }

  .collection-header:hover .collection-label {
    color: var(--text-muted);
  }

  .collection-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--text-dimmed);
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: color 0.15s;
  }

  .collection-icon {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
  }

  .add-btn {
    background: none;
    border: none;
    color: var(--text-faint);
    cursor: pointer;
    font-size: 16px;
    padding: 0 4px;
    line-height: 1;
    transition: color 0.15s;
  }

  .add-btn:hover {
    color: var(--accent);
  }

  .delete-btn {
    background: none;
    border: none;
    color: var(--text-faint);
    cursor: pointer;
    font-size: 12px;
    padding: 0 4px;
    line-height: 1;
    transition: color 0.15s;
    opacity: 0;
  }

  .collection-header:hover .delete-btn {
    opacity: 1;
  }

  .delete-btn:hover {
    color: #ef4444;
  }

  .page-item {
    padding: 6px 16px 6px 32px;
    cursor: pointer;
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.15s;
    border-left: 2px solid transparent;
    margin-left: 14px;
  }

  .page-item:hover {
    color: var(--text-secondary);
    background: rgba(255,255,255,0.03);
  }

  .page-item.active {
    color: var(--accent);
    border-left-color: var(--accent);
    background: var(--accent-bg);
  }

  .all-collections {
    padding: 6px 16px;
  }

  .all-collections-btn {
    padding: 5px 0;
    margin: 0;
    border: none;
    background: none;
    font-size: 11px;
    color: var(--text-dimmed);
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-family: inherit;
    transition: color 0.15s;
  }

  .all-collections-btn.active {
    color: var(--accent);
  }

  .sidebar-footer {
    border-top: 1px solid var(--border-primary);
    padding: 10px 16px;
  }

  .input-row {
    display: flex;
    gap: 6px;
    padding: 6px 16px;
  }

  .input {
    flex: 1;
    padding: 5px 8px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-secondary);
    border-radius: 5px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 11px;
    outline: none;
  }

  .small-btn {
    padding: 4px 8px;
    border-radius: 4px;
    border: none;
    background: var(--accent);
    color: var(--bg-primary);
    cursor: pointer;
    font-family: inherit;
    font-size: 10px;
    font-weight: 600;
  }

  /* MAIN */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 24px;
    border-bottom: 1px solid var(--border-primary);
    background: var(--bg-secondary);
    min-height: 48px;
    flex-shrink: 0;
  }

  .tabs {
    display: flex;
    gap: 4px;
  }

  .tab {
    padding: 5px 14px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-dimmed);
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    transition: all 0.15s;
    letter-spacing: 0.5px;
  }

  .tab:hover {
    color: var(--text-secondary);
  }

  .tab.active {
    background: var(--bg-tertiary);
    color: var(--accent);
  }

  .top-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .action-btn {
    padding: 5px 12px;
    border-radius: 6px;
    border: 1px solid var(--border-secondary);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-family: inherit;
    font-size: 11px;
    transition: all 0.15s;
  }

  .action-btn:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .action-btn.primary {
    background: var(--accent);
    color: var(--bg-primary);
    border: none;
    font-weight: 600;
  }

  .action-btn.primary:hover {
    background: var(--accent-hover);
  }

  .action-btn.danger {
    border-color: #ef4444;
    color: #ef4444;
  }

  .action-btn.danger:hover {
    background: rgba(239,68,68,0.1);
  }

  .content {
    flex: 1;
    overflow: auto;
    padding: 32px 40px;
    height: 0; /* Fix flex container height issue */
  }

  .content.graph-tab {
    padding: 0;
    overflow: hidden;
    position: relative;
  }

  .page-title {
    font-size: 26px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
    letter-spacing: -0.5px;
  }

  .page-meta {
    font-size: 10px;
    color: var(--text-faint);
    margin-bottom: 24px;
    letter-spacing: 0.5px;
  }

  .rendered {
    color: var(--text-secondary);
    max-width: 720px;
  }

  .rendered h1 {
    font-size: 22px;
    color: var(--text-primary);
    margin: 0 0 8px;
    font-weight: 700;
    border-bottom: 1px solid var(--border-primary);
    padding-bottom: 8px;
  }

  .rendered h2 {
    font-size: 16px;
    color: var(--text-secondary);
    margin: 20px 0 8px;
    font-weight: 600;
  }

  .rendered h3 {
    font-size: 14px;
    color: var(--text-muted);
    margin: 16px 0 6px;
    font-weight: 600;
  }

  .rendered p {
    margin: 8px 0;
    color: var(--text-muted);
  }

  .rendered code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--accent);
    font-size: 12px;
    border: 1px solid var(--border-secondary);
  }

  .rendered pre {
    background: var(--bg-quaternary);
    border: 1px solid var(--border-secondary);
    border-radius: 8px;
    padding: 14px;
    overflow-x: auto;
    margin: 12px 0;
  }

  .rendered pre code {
    background: none;
    border: none;
    padding: 0;
    color: var(--text-secondary);
    font-size: 12px;
  }

  .rendered ul {
    list-style: none;
    padding: 0;
    margin: 8px 0;
  }

  .rendered li {
    padding: 3px 0;
    color: var(--text-muted);
  }

  .rendered li::before {
    content: "›";
    color: var(--accent);
    margin-right: 8px;
    font-weight: bold;
  }

  .wiki-link {
    color: var(--accent);
    cursor: pointer;
    text-decoration: none;
    border-bottom: 1px solid var(--accent-border);
    transition: all 0.15s;
  }

  .wiki-link:hover {
    color: var(--accent-hover);
    border-bottom-color: var(--accent-hover);
  }

  .wiki-link.broken {
    color: var(--text-dimmed);
    border-bottom-color: var(--text-dimmed);
    cursor: default;
  }

  .textarea {
    width: 100%;
    min-height: 500px;
    background: var(--bg-primary);
    border: 1px solid var(--border-secondary);
    border-radius: 8px;
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 13px;
    padding: 20px;
    resize: vertical;
    outline: none;
    line-height: 1.8;
    max-width: 720px;
  }

  .edit-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    max-width: 720px;
    align-items: center;
  }

  .toolbar-hint {
    font-size: 10px;
    color: var(--text-faint);
  }

  .links-panel {
    margin-top: 32px;
    max-width: 720px;
    display: flex;
    gap: 24px;
  }

  .links-panel-section {
    flex: 1;
  }

  .links-panel-title {
    font-size: 10px;
    color: var(--text-faint);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .link-chip {
    display: inline-block;
    padding: 4px 10px;
    background: var(--accent-bg);
    border: 1px solid var(--accent-border);
    border-radius: 20px;
    font-size: 11px;
    color: var(--accent);
    cursor: pointer;
    margin: 2px;
    transition: all 0.15s;
  }

  .link-chip:hover {
    background: var(--accent-bg);
    opacity: 0.8;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-faint);
  }

  .empty-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.4;
  }

  .empty-text {
    font-size: 13px;
    text-align: center;
    max-width: 280px;
    line-height: 1.6;
  }

  /* GRAPH */
  .graph-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
  }

  .graph-canvas {
    width: 100%;
    height: 100%;
    display: block;
  }

  .graph-legend {
    position: absolute;
    bottom: 16px;
    left: 16px;
    display: flex;
    gap: 16px;
    background: rgba(15,17,23,0.85);
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid var(--border-primary);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--text-dimmed);
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .legend-divider {
    margin-left: 8px;
    border-left: 1px solid var(--border-secondary);
    padding-left: 12px;
  }

  .hidden {
    display: none;
  }

  /* NOTIFICATIONS */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    background: var(--accent);
    color: var(--bg-primary);
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    z-index: 1000;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.2s ease;
    pointer-events: none;
  }

  .notification.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* SETTINGS */
  .settings-section {
    max-width: 600px;
    margin-bottom: 32px;
  }

  .settings-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-primary);
  }

  .settings-field {
    margin-bottom: 16px;
  }

  .settings-label {
    display: block;
    font-size: 11px;
    color: var(--text-dimmed);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .settings-input {
    width: 100%;
    padding: 8px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-secondary);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
  }

  .settings-input:focus {
    border-color: var(--accent);
  }

  .settings-description {
    font-size: 11px;
    color: var(--text-faint);
    margin-top: 4px;
    line-height: 1.4;
  }

  .collection-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-secondary);
    border-radius: 6px;
    margin-bottom: 8px;
  }

  .collection-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .collection-icon-small {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }

  .collection-details {
    display: flex;
    flex-direction: column;
  }

  .collection-name {
    font-size: 13px;
    color: var(--text-primary);
    font-weight: 500;
  }

  .collection-count {
    font-size: 11px;
    color: var(--text-dimmed);
  }

  .delete-collection-btn {
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #ef4444;
    background: transparent;
    color: #ef4444;
    cursor: pointer;
    font-family: inherit;
    font-size: 10px;
    transition: all 0.15s;
  }

  .delete-collection-btn:hover {
    background: rgba(239,68,68,0.1);
  }

  /* MOBILE RESPONSIVE */
  .mobile-menu-btn {
    display: none;
    padding: 8px;
    background: none;
    border: none;
    color: var(--text-primary);
    cursor: pointer;
    font-size: 18px;
    border-radius: 6px;
    transition: background-color 0.15s;
  }

  .mobile-menu-btn:hover {
    background: var(--bg-tertiary);
  }

  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
  }

  @media (max-width: 768px) {
    .mobile-menu-btn {
      display: block;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 101;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-overlay.show {
      display: block;
    }

    .main {
      width: 100%;
    }

    .content {
      padding: 20px 16px;
    }

    .page-title {
      font-size: 22px;
    }

    .rendered {
      max-width: 100%;
    }

    .textarea {
      max-width: 100%;
      min-height: 400px;
    }

    .edit-toolbar {
      max-width: 100%;
    }

    .links-panel {
      flex-direction: column;
      gap: 16px;
    }

    .top-bar {
      padding: 8px 16px;
    }

    .tabs {
      gap: 2px;
    }

    .tab {
      padding: 4px 10px;
      font-size: 11px;
    }

    .action-btn {
      padding: 4px 8px;
      font-size: 10px;
    }

    /* Graph responsive styles */
    .graph-legend {
      bottom: 8px;
      left: 8px;
      right: 8px;
      flex-wrap: wrap;
      gap: 8px;
      padding: 6px 10px;
    }

    .legend-item {
      font-size: 9px;
    }

    .graph-controls {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
    }

    .graph-control-btn {
      padding: 4px 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 10px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .graph-control-btn:hover {
      background: var(--bg-tertiary);
    }
  }

  @media (max-width: 480px) {
    .sidebar {
      width: 280px;
    }

    .content {
      padding: 16px 12px;
    }

    .page-title {
      font-size: 20px;
    }

    .top-actions {
      gap: 4px;
    }

    /* Graph responsive styles for small mobile */
    .graph-legend {
      bottom: 4px;
      left: 4px;
      right: 4px;
      gap: 6px;
      padding: 4px 6px;
    }

    .legend-item {
      font-size: 8px;
      gap: 4px;
    }

    .legend-dot {
      width: 6px;
      height: 6px;
    }

    .graph-controls {
      top: 4px;
      right: 4px;
      gap: 2px;
    }

    .graph-control-btn {
      padding: 3px 5px;
      font-size: 9px;
    }
  }
</style>
</head>
<body>

<div class="app">
  <!-- MOBILE MENU BUTTON -->
  <button class="mobile-menu-btn" id="mobileMenuBtn">☰</button>
  
  <!-- SIDEBAR OVERLAY -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo" id="appTitle">Seed</div>
      <div class="logo-sub" id="appSubtitle">Knowledge Capsule</div>
      <input type="text" class="search-box" id="searchInput" placeholder="Search pages...">
    </div>
    <div class="sidebar-content" id="sidebarContent">
      <div class="all-collections">
        <button class="all-collections-btn active" id="allCollectionsBtn">All Collections</button>
      </div>
      <!-- Collections will be rendered here -->
    </div>
    <div class="sidebar-footer">
      <button class="action-btn" id="newCollectionBtn" style="width: 100%; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">+ New Collection</button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="top-bar">
      <div class="tabs">
        <button class="tab active" id="pagesTab">Pages</button>
        <button class="tab" id="graphTab">Graph</button>
        <button class="tab" id="settingsTab">Settings</button>
      </div>
      <div class="top-actions" id="topActions"></div>
    </div>
    <div class="content" id="mainContent">
      <div class="empty-state">
        <div class="empty-icon">⌘</div>
        <div class="empty-text">Select a page from the sidebar, or create a new one to get started.</div>
      </div>
    </div>
  </div>
</div>

<!-- NOTIFICATION -->
<div class="notification" id="notification"></div>

<script>
// ─── DATA ────────────────────────────────────────────────────────────────────
let collections = [];

let pages = [];

// ─── STATE ───────────────────────────────────────────────────────────────────
let state = {
  activePageId: null,
  activeTab: 'pages',
  searchQuery: '',
  editing: false,
  editContent: '',
  sidebarCollectionFilter: null,
  creatingPage: false,
  creatingCollection: false,
  appTitle: 'Seed',
  appSubtitle: 'Knowledge Capsule',
  currentTheme: 'default',
};

// ─── UTILITIES ───────────────────────────────────────────────────────────────
function showNotification(message, duration = 2000) {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, duration);
}

function extractLinks(content) {
  const matches = content.match(/\[\[([^\]]+)\]\]/g) || [];
  return matches.map(m => m.replace(/\[\[|\]\]/g, ""));
}

function renderMarkdown(content) {
  let html = content;
  html = html.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code class="lang-$1">$2</code></pre>');
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  html = html.replace(/\[\[([^\]]+)\]\]/g, (_, title) => {
    const target = pages.find(p => p.title === title);
    if (target) return `<a class="wiki-link" data-id="${target.id}">${title}</a>`;
    return `<a class="wiki-link broken">${title}</a>`;
  });
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
  html = html.replace(/\n\n/g, '</p><p>');
  html = `<p>${html}</p>`;
  html = html.replace(/<p><\/p>/g, '');
  html = html.replace(/<p><(h[1-6]|pre|ul)/g, '<$1');
  html = html.replace(/<\/(h[1-6]|pre|ul)><\/p>/g, '</$1>');
  return html;
}

function getBacklinks(pageId) {
  const page = pages.find(p => p.id === pageId);
  if (!page) return [];
  return pages.filter(p => p.id !== pageId && extractLinks(p.content).includes(page.title));
}

function getForwardLinks(pageId) {
  const page = pages.find(p => p.id === pageId);
  if (!page) return [];
  return extractLinks(page.content)
    .map(title => pages.find(p => p.title === title))
    .filter(Boolean);
}

function getFilteredPages() {
  return pages.filter(p => {
    const matchesSearch = !state.searchQuery || 
      p.title.toLowerCase().includes(state.searchQuery.toLowerCase()) || 
      p.content.toLowerCase().includes(state.searchQuery.toLowerCase());
    const matchesCollection = !state.sidebarCollectionFilter || p.collectionId === state.sidebarCollectionFilter;
    return matchesSearch && matchesCollection;
  });
}

// ─── RENDER ──────────────────────────────────────────────────────────────────
function renderSidebar() {
  const container = document.getElementById('sidebarContent');
  const allBtn = document.getElementById('allCollectionsBtn');
  
  // Update all collections button
  allBtn.classList.toggle('active', state.sidebarCollectionFilter === null);
  
  const filteredPages = getFilteredPages();
  
  let html = '<div class="all-collections"><button class="all-collections-btn' + 
    (state.sidebarCollectionFilter === null ? ' active' : '') + 
    '" id="allCollectionsBtn">All Collections</button></div>';
  
  collections.forEach(col => {
    const colPages = filteredPages.filter(p => p.collectionId === col.id);
    const isActive = state.sidebarCollectionFilter === col.id;
    
    html += `
      <div class="collection-group">
        <div class="collection-header" data-collection-id="${col.id}">
          <div class="collection-label" style="color: ${isActive ? col.color : '#6b7280'}">
            <div class="collection-icon" style="background: ${col.color}18; color: ${col.color}">${col.icon}</div>
            ${col.name}
          </div>
          <div style="display: flex; gap: 4px;">
            <button class="add-btn" data-action="new-page" data-collection-id="${col.id}">+</button>
            <button class="delete-btn" data-action="delete-collection" data-collection-id="${col.id}">×</button>
          </div>
        </div>
        ${colPages.map(p => `
          <div class="page-item${state.activePageId === p.id ? ' active' : ''}" data-page-id="${p.id}">
            ${p.title}
          </div>
        `).join('')}
      </div>
    `;
  });
  
  if (state.creatingPage) {
    html += `
      <div class="input-row">
        <input type="text" class="input" id="newPageInput" placeholder="Page title..." autofocus>
        <button class="small-btn" id="confirmPageBtn">✓</button>
      </div>
    `;
  }
  
  if (state.creatingCollection) {
    html += `
      <div class="input-row" style="margin-top: 8px;">
        <input type="text" class="input" id="newCollectionInput" placeholder="Collection name..." autofocus>
        <button class="small-btn" id="confirmCollectionBtn">✓</button>
      </div>
    `;
  }
  
  container.innerHTML = html;
  
  // Attach event listeners
  document.querySelectorAll('.collection-header').forEach(el => {
    el.addEventListener('click', (e) => {
      if (e.target.classList.contains('add-btn')) return;
      const colId = el.dataset.collectionId;
      state.sidebarCollectionFilter = state.sidebarCollectionFilter === colId ? null : colId;
      render();
    });
  });
  
  document.querySelectorAll('.page-item').forEach(el => {
    el.addEventListener('click', () => {
      state.activePageId = el.dataset.pageId;
      state.editing = false;
      render();
    });
  });
  
  document.querySelectorAll('[data-action="new-page"]').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      state.sidebarCollectionFilter = el.dataset.collectionId;
      state.creatingPage = true;
      render();
    });
  });
  
  document.querySelectorAll('[data-action="delete-collection"]').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      deleteCollection(el.dataset.collectionId);
    });
  });
  
  if (state.creatingPage) {
    const input = document.getElementById('newPageInput');
    const btn = document.getElementById('confirmPageBtn');
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') createPage();
      if (e.key === 'Escape') { state.creatingPage = false; render(); }
    });
    btn.addEventListener('click', createPage);
  }
  
  if (state.creatingCollection) {
    const input = document.getElementById('newCollectionInput');
    const btn = document.getElementById('confirmCollectionBtn');
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') createCollection();
      if (e.key === 'Escape') { state.creatingCollection = false; render(); }
    });
    btn.addEventListener('click', createCollection);
  }
}

function renderTopBar() {
  const actionsContainer = document.getElementById('topActions');
  const pagesTab = document.getElementById('pagesTab');
  const graphTab = document.getElementById('graphTab');
  const settingsTab = document.getElementById('settingsTab');
  
  pagesTab.classList.toggle('active', state.activeTab === 'pages');
  graphTab.classList.toggle('active', state.activeTab === 'graph');
  settingsTab.classList.toggle('active', state.activeTab === 'settings');
  
  let html = '';
  
  if (state.activeTab === 'settings') {
    html = `
      <button class="action-btn primary" id="saveSettingsBtn">Save Settings</button>
    `;
  } else if (state.activeTab === 'pages' && state.activePageId && !state.editing) {
    html = `
      <button class="action-btn" id="editBtn">Edit</button>
      <button class="action-btn danger" id="deleteBtn">Delete</button>
    `;
  } else if (state.editing) {
    html = `
      <button class="action-btn primary" id="saveBtn">Save</button>
      <button class="action-btn" id="cancelBtn">Cancel</button>
    `;
  } else if (state.activeTab === 'pages' && !state.activePageId) {
    html = `<button class="action-btn primary" id="newPageTopBtn">+ New Page</button>`;
  }
  
  actionsContainer.innerHTML = html;
  
  // Attach listeners
  const editBtn = document.getElementById('editBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const newPageTopBtn = document.getElementById('newPageTopBtn');
  const saveSettingsBtn = document.getElementById('saveSettingsBtn');
  
  if (editBtn) editBtn.addEventListener('click', () => {
    const page = pages.find(p => p.id === state.activePageId);
    state.editing = true;
    state.editContent = page.content;
    render();
  });
  
  if (deleteBtn) deleteBtn.addEventListener('click', deletePage);
  if (saveBtn) saveBtn.addEventListener('click', savePage);
  if (cancelBtn) cancelBtn.addEventListener('click', () => { state.editing = false; render(); });
  if (newPageTopBtn) newPageTopBtn.addEventListener('click', () => { state.creatingPage = true; render(); });
  if (saveSettingsBtn) saveSettingsBtn.addEventListener('click', saveSettings);
}

function renderMainContent() {
  const container = document.getElementById('mainContent');
  
  // Update content class for graph tab
  if (state.activeTab === 'graph') {
    container.classList.add('graph-tab');
    renderGraph();
    return;
  } else {
    container.classList.remove('graph-tab');
  }
  
  if (state.activeTab === 'settings') {
    renderSettings();
    return;
  }
  
  // Pages tab
  const page = pages.find(p => p.id === state.activePageId);
  
  if (!page) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⌘</div>
        <div class="empty-text">Select a page from the sidebar, or create a new one to get started.</div>
      </div>
    `;
    return;
  }
  
  const collection = collections.find(c => c.id === page.collectionId);
  const backlinks = getBacklinks(page.id);
  const forwardLinks = getForwardLinks(page.id);
  
  if (state.editing) {
    container.innerHTML = `
      <div class="page-title">${page.title}</div>
      <div class="page-meta">
        Collection: ${collection?.name || '—'} · 
        Created ${new Date(page.createdAt).toLocaleDateString()} · 
        Updated ${new Date(page.updatedAt).toLocaleDateString()}
      </div>
      <div class="edit-toolbar">
        <button class="action-btn" id="insertLinkBtn" style="font-size: 10px;">⛓ Link</button>
        <span class="toolbar-hint">Use [[Page Title]] to link pages</span>
      </div>
      <textarea class="textarea" id="editTextarea">${state.editContent}</textarea>
    `;
    
    document.getElementById('insertLinkBtn').addEventListener('click', insertWikiLink);
  } else {
    const renderedContent = renderMarkdown(page.content);
    
    let linksHtml = '';
    if (forwardLinks.length > 0 || backlinks.length > 0) {
      linksHtml = '<div class="links-panel">';
      if (forwardLinks.length > 0) {
        linksHtml += `
          <div class="links-panel-section">
            <div class="links-panel-title">Links →</div>
            ${forwardLinks.map(p => `<span class="link-chip" data-page-id="${p.id}">${p.title}</span>`).join('')}
          </div>
        `;
      }
      if (backlinks.length > 0) {
        linksHtml += `
          <div class="links-panel-section">
            <div class="links-panel-title">← Backlinks</div>
            ${backlinks.map(p => `<span class="link-chip" data-page-id="${p.id}">${p.title}</span>`).join('')}
          </div>
        `;
      }
      linksHtml += '</div>';
    }
    
    container.innerHTML = `
      <div class="page-title">${page.title}</div>
      <div class="page-meta">
        Collection: ${collection?.name || '—'} · 
        Created ${new Date(page.createdAt).toLocaleDateString()} · 
        Updated ${new Date(page.updatedAt).toLocaleDateString()}
      </div>
      <div class="rendered">${renderedContent}</div>
      ${linksHtml}
    `;
    
    // Attach wiki-link listeners
    container.querySelectorAll('.wiki-link[data-id]').forEach(link => {
      link.addEventListener('click', () => {
        state.activePageId = link.dataset.id;
        state.editing = false;
        render();
      });
    });
    
    // Attach link chip listeners
    container.querySelectorAll('.link-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        state.activePageId = chip.dataset.pageId;
        state.editing = false;
        render();
      });
    });
  }
}

function renderSettings() {
  const container = document.getElementById('mainContent');
  
  const collectionsHtml = collections.map(col => {
    const pageCount = pages.filter(p => p.collectionId === col.id).length;
    return `
      <div class="collection-item">
        <div class="collection-info">
          <div class="collection-icon-small" style="background: ${col.color}18; color: ${col.color}">${col.icon}</div>
          <div class="collection-details">
            <div class="collection-name">${col.name}</div>
            <div class="collection-count">${pageCount} ${pageCount === 1 ? 'page' : 'pages'}</div>
          </div>
        </div>
        <button class="delete-collection-btn" data-collection-id="${col.id}">Delete</button>
      </div>
    `;
  }).join('');
  
  container.innerHTML = `
    <div class="settings-section">
      <div class="settings-title">Application Settings</div>
      
      <div class="settings-field">
        <label class="settings-label" for="titleInput">Application Title</label>
        <input type="text" class="settings-input" id="titleInput" value="${state.appTitle}">
        <div class="settings-description">The main title displayed in the sidebar header</div>
      </div>
      
      <div class="settings-field">
        <label class="settings-label" for="subtitleInput">Application Subtitle</label>
        <input type="text" class="settings-input" id="subtitleInput" value="${state.appSubtitle}">
        <div class="settings-description">The subtitle displayed below the main title</div>
      </div>
      
      <div class="settings-field">
        <label class="settings-label" for="themeSelect">Theme</label>
        <select class="settings-input" id="themeSelect">
          <option value="default" ${state.currentTheme === 'default' ? 'selected' : ''}>Default (Dark Green)</option>
          <option value="selenized-dark" ${state.currentTheme === 'selenized-dark' ? 'selected' : ''}>Selenized Dark</option>
          <option value="selenized-black" ${state.currentTheme === 'selenized-black' ? 'selected' : ''}>Selenized Black</option>
          <option value="selenized-light" ${state.currentTheme === 'selenized-light' ? 'selected' : ''}>Selenized Light</option>
          <option value="selenized-white" ${state.currentTheme === 'selenized-white' ? 'selected' : ''}>Selenized White</option>
          <option value="orange-black" ${state.currentTheme === 'orange-black' ? 'selected' : ''}>Orange & Black</option>
        </select>
        <div class="settings-description">Choose your preferred color theme</div>
      </div>
    </div>
    
    <div class="settings-section">
      <div class="settings-title">Manage Collections</div>
      ${collectionsHtml}
    </div>
  `;
  
  // Attach delete collection listeners
  container.querySelectorAll('.delete-collection-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const collectionId = btn.dataset.collectionId;
      deleteCollection(collectionId);
    });
  });
}

function applyTheme(themeName) {
  const body = document.body;
  
  // Remove all theme attributes
  body.removeAttribute('data-theme');
  
  // Apply the selected theme
  if (themeName !== 'default') {
    body.setAttribute('data-theme', themeName);
  }
}

function saveSettings() {
  const titleInput = document.getElementById('titleInput');
  const subtitleInput = document.getElementById('subtitleInput');
  const themeSelect = document.getElementById('themeSelect');
  
  if (titleInput) state.appTitle = titleInput.value.trim();
  if (subtitleInput) state.appSubtitle = subtitleInput.value.trim();
  if (themeSelect) {
    state.currentTheme = themeSelect.value;
    applyTheme(state.currentTheme);
  }
  
  // Save to localStorage
  localStorage.setItem('seed-settings', JSON.stringify({
    appTitle: state.appTitle,
    appSubtitle: state.appSubtitle,
    currentTheme: state.currentTheme
  }));
  
  // Update the UI
  document.getElementById('appTitle').textContent = state.appTitle;
  document.getElementById('appSubtitle').textContent = state.appSubtitle;
  document.title = `${state.appTitle} - ${state.appSubtitle}`;
  
  render();
}

function deleteCollection(collectionId) {
  const collection = collections.find(c => c.id === collectionId);
  if (!collection) return;
  
  const pageCount = pages.filter(p => p.collectionId === collectionId).length;
  let confirmMessage = `Delete collection "${collection.name}"?`;
  
  if (pageCount > 0) {
    confirmMessage += `\n\nThis collection contains ${pageCount} ${pageCount === 1 ? 'page' : 'pages'}. These pages will also be deleted.`;
  }
  
  if (!confirm(confirmMessage)) return;
  
  // Delete the collection
  collections = collections.filter(c => c.id !== collectionId);
  
  // Delete pages in this collection
  pages = pages.filter(p => p.collectionId !== collectionId);
  
  // Save to localStorage
  saveWikiData();
  
  // Reset active page if it was in this collection
  const activePage = pages.find(p => p.id === state.activePageId);
  if (!activePage) {
    state.activePageId = null;
    state.editing = false;
  }
  
  // Reset collection filter if it was this collection
  if (state.sidebarCollectionFilter === collectionId) {
    state.sidebarCollectionFilter = null;
  }
  
  render();
}

function renderGraph() {
  const container = document.getElementById('mainContent');
  const isMobile = window.innerWidth <= 768;
  
  container.innerHTML = `
    <div class="graph-container">
      <canvas class="graph-canvas" id="graphCanvas"></canvas>
      ${isMobile ? `
        <div class="graph-controls">
          <button class="graph-control-btn" id="zoomInBtn">+</button>
          <button class="graph-control-btn" id="zoomOutBtn">−</button>
          <button class="graph-control-btn" id="resetBtn">⟲</button>
        </div>
      ` : ''}
      <div class="graph-legend">
        ${collections.map(c => `
          <div class="legend-item">
            <div class="legend-dot" style="background: ${c.color}"></div>
            ${c.name}
          </div>
        `).join('')}
        <div class="legend-item legend-divider">${isMobile ? 'Tap node to open' : 'Click a node to open'}</div>
      </div>
    </div>
  `;
  
  initGraph();
}

// ─── GRAPH ───────────────────────────────────────────────────────────────────
let graphState = {
  nodes: [],
  links: [],
  animationFrame: null,
  hoveredNode: null,
  zoom: 1,
  panX: 0,
  panY: 0,
  isDragging: false,
  dragStartX: 0,
  dragStartY: 0,
  lastTouchDistance: 0,
};

function initGraph() {
  const canvas = document.getElementById('graphCanvas');
  const ctx = canvas.getContext('2d');
  
  // Set canvas size
  const resize = () => {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    initGraphData();
  };
  resize();
  window.addEventListener('resize', resize);
  
  initGraphData();
  animateGraph();
  
  // Mouse interaction
  canvas.addEventListener('mousemove', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    
    graphState.hoveredNode = null;
    graphState.nodes.forEach(n => {
      const dx = n.x - mx;
      const dy = n.y - my;
      if (Math.sqrt(dx*dx + dy*dy) < 14) {
        graphState.hoveredNode = n.id;
      }
    });
    
    canvas.style.cursor = graphState.hoveredNode ? 'pointer' : 'default';
  });
  
  canvas.addEventListener('click', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    
    graphState.nodes.forEach(n => {
      const dx = n.x - mx;
      const dy = n.y - my;
      if (Math.sqrt(dx*dx + dy*dy) < 14) {
        state.activePageId = n.id;
        state.activeTab = 'pages';
        state.editing = false;
        render();
      }
    });
  });
  
  // Mobile controls
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const resetBtn = document.getElementById('resetBtn');
  
  if (zoomInBtn) {
    zoomInBtn.addEventListener('click', () => {
      graphState.zoom = Math.min(graphState.zoom * 1.2, 3);
    });
  }
  
  if (zoomOutBtn) {
    zoomOutBtn.addEventListener('click', () => {
      graphState.zoom = Math.max(graphState.zoom / 1.2, 0.5);
    });
  }
  
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      graphState.zoom = 1;
      graphState.panX = 0;
      graphState.panY = 0;
      initGraphData();
    });
  }
  
  // Touch support for mobile
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    
    if (e.touches.length === 1) {
      graphState.isDragging = true;
      graphState.dragStartX = touch.clientX - rect.left - graphState.panX;
      graphState.dragStartY = touch.clientY - rect.top - graphState.panY;
    } else if (e.touches.length === 2) {
      // Pinch to zoom
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      graphState.lastTouchDistance = Math.sqrt(dx * dx + dy * dy);
    }
  });
  
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    
    if (e.touches.length === 1 && graphState.isDragging) {
      // Pan
      const touch = e.touches[0];
      graphState.panX = touch.clientX - rect.left - graphState.dragStartX;
      graphState.panY = touch.clientY - rect.top - graphState.dragStartY;
    } else if (e.touches.length === 2) {
      // Pinch to zoom
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (graphState.lastTouchDistance > 0) {
        const scale = distance / graphState.lastTouchDistance;
        graphState.zoom = Math.max(0.5, Math.min(3, graphState.zoom * scale));
      }
      
      graphState.lastTouchDistance = distance;
    }
  });
  
  canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    
    if (e.touches.length === 0) {
      // Check for tap on node
      if (!graphState.isDragging && graphState.zoom === 1 && graphState.panX === 0 && graphState.panY === 0) {
        const touch = e.changedTouches[0];
        const rect = canvas.getBoundingClientRect();
        const mx = touch.clientX - rect.left;
        const my = touch.clientY - rect.top;
        
        graphState.nodes.forEach(n => {
          const dx = n.x - mx;
          const dy = n.y - my;
          if (Math.sqrt(dx*dx + dy*dy) < 20) { // Larger touch target
            state.activePageId = n.id;
            state.activeTab = 'pages';
            state.editing = false;
            render();
          }
        });
      }
      
      graphState.isDragging = false;
      graphState.lastTouchDistance = 0;
    }
  });
}

function initGraphData() {
  const canvas = document.getElementById('graphCanvas');
  if (!canvas) return;
  
  const w = canvas.width;
  const h = canvas.height;
  const cx = w / 2;
  const cy = h / 2;
  
  // Create nodes
  graphState.nodes = pages.map((p, i) => {
    const existing = graphState.nodes.find(n => n.id === p.id);
    if (existing) return existing;
    
    const angle = (i / pages.length) * Math.PI * 2;
    const r = Math.min(w, h) * 0.4; // Increased from 0.3 to 0.4
    return {
      id: p.id,
      title: p.title,
      collectionId: p.collectionId,
      x: cx + Math.cos(angle) * r + (Math.random() - 0.5) * 120,
      y: cy + Math.sin(angle) * r + (Math.random() - 0.5) * 120,
      vx: 0,
      vy: 0,
    };
  });
  
  // Create links
  graphState.links = [];
  pages.forEach(p => {
    extractLinks(p.content).forEach(title => {
      const target = pages.find(t => t.title === title);
      if (target) {
        graphState.links.push({ source: p.id, target: target.id });
      }
    });
  });
}

function animateGraph() {
  const canvas = document.getElementById('graphCanvas');
  if (!canvas || state.activeTab !== 'graph') return;
  
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  const cx = w / 2;
  const cy = h / 2;
  
  // Physics (optimized for mobile)
  const nodes = graphState.nodes;
  const links = graphState.links;
  const isMobile = window.innerWidth <= 768;
  const maxForce = isMobile ? 4 : 8;
  const repulsionStrength = isMobile ? 600 : 1200;
  
  // Repulsion
  for (let i = 0; i < nodes.length; i++) {
    for (let j = i + 1; j < nodes.length; j++) {
      const dx = nodes[i].x - nodes[j].x;
      const dy = nodes[i].y - nodes[j].y;
      const d = Math.sqrt(dx * dx + dy * dy) || 1;
      const force = Math.min(repulsionStrength / (d * d), maxForce);
      nodes[i].vx += (dx / d) * force;
      nodes[i].vy += (dy / d) * force;
      nodes[j].vx -= (dx / d) * force;
      nodes[j].vy -= (dy / d) * force;
    }
  }
  
  // Attraction (links)
  links.forEach(link => {
    const s = nodes.find(n => n.id === link.source);
    const t = nodes.find(n => n.id === link.target);
    if (!s || !t) return;
    const dx = t.x - s.x;
    const dy = t.y - s.y;
    const d = Math.sqrt(dx * dx + dy * dy) || 1;
    const force = (d - 120) * 0.02; // Increased ideal distance from 80 to 120
    s.vx += (dx / d) * force;
    s.vy += (dy / d) * force;
    t.vx -= (dx / d) * force;
    t.vy -= (dy / d) * force;
  });
  
  // Center gravity
  nodes.forEach(n => {
    n.vx += (cx - n.x) * 0.005;
    n.vy += (cy - n.y) * 0.005;
  });
  
  // Update positions
  nodes.forEach(n => {
    n.vx *= 0.9;
    n.vy *= 0.9;
    n.x += n.vx;
    n.y += n.vy;
    n.x = Math.max(40, Math.min(w - 40, n.x));
    n.y = Math.max(40, Math.min(h - 40, n.y));
  });
  
  // Draw
  ctx.clearRect(0, 0, w, h);
  
  // Apply zoom and pan transformations
  ctx.save();
  ctx.translate(cx + graphState.panX, cy + graphState.panY);
  ctx.scale(graphState.zoom, graphState.zoom);
  ctx.translate(-cx, -cy);
  
  // Draw links
  links.forEach(link => {
    const s = nodes.find(n => n.id === link.source);
    const t = nodes.find(n => n.id === link.target);
    if (!s || !t) return;
    const isActive = s.id === state.activePageId || t.id === state.activePageId;
    ctx.beginPath();
    ctx.moveTo(s.x, s.y);
    ctx.lineTo(t.x, t.y);
    ctx.strokeStyle = isActive ? 'rgba(74,222,128,0.6)' : 'rgba(255,255,255,0.08)';
    ctx.lineWidth = isActive ? 2 : 1;
    ctx.stroke();
  });
  
  // Draw nodes
  nodes.forEach(n => {
    const col = collections.find(c => c.id === n.collectionId);
    const color = col ? col.color : '#fff';
    const isActive = n.id === state.activePageId;
    const isHovered = graphState.hoveredNode === n.id;
    const radius = isActive ? 10 : isHovered ? 8 : 6;
    
    // Glow
    const glow = ctx.createRadialGradient(n.x, n.y, 0, n.x, n.y, radius * 3);
    glow.addColorStop(0, color + '44');
    glow.addColorStop(1, 'transparent');
    ctx.beginPath();
    ctx.arc(n.x, n.y, radius * 3, 0, Math.PI * 2);
    ctx.fillStyle = glow;
    ctx.fill();
    
    // Node
    ctx.beginPath();
    ctx.arc(n.x, n.y, radius, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    if (isActive) {
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
    
    // Label
    ctx.font = isActive ? "600 11px 'Courier New', monospace" : "400 10px 'Courier New', monospace";
    ctx.fillStyle = isActive ? '#fff' : 'rgba(255,255,255,0.6)';
    ctx.textAlign = 'center';
    ctx.fillText(n.title, n.x, n.y + radius + 14);
  });
  
  ctx.restore();
  graphState.animationFrame = requestAnimationFrame(animateGraph);
}

// ─── ACTIONS ─────────────────────────────────────────────────────────────────
function createPage() {
  const input = document.getElementById('newPageInput');
  const title = input?.value.trim();
  if (!title) return;
  
  const colId = state.sidebarCollectionFilter || collections[0]?.id;
  const newPage = {
    id: 'p-' + Date.now(),
    collectionId: colId,
    title: title,
    content: `# ${title}\n\nStart writing here...`,
    createdAt: Date.now(),
    updatedAt: Date.now(),
  };
  
  pages.push(newPage);
  saveWikiData();
  state.activePageId = newPage.id;
  state.creatingPage = false;
  render();
}

function createCollection() {
  const input = document.getElementById('newCollectionInput');
  const name = input?.value.trim();
  if (!name) return;
  
  const colors = ['#60a5fa','#f472b6','#34d399','#fbbf24','#a78bfa','#fb923c'];
  const newCol = {
    id: 'col-' + Date.now(),
    name: name,
    icon: name[0].toUpperCase(),
    color: colors[Math.floor(Math.random() * colors.length)],
  };
  
  collections.push(newCol);
  saveWikiData();
  state.creatingCollection = false;
  render();
}

function saveWikiData() {
  localStorage.setItem('seed-wiki-data', JSON.stringify({
    collections: collections,
    pages: pages
  }));
}

function loadWikiData() {
  const saved = localStorage.getItem('seed-wiki-data');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      collections = data.collections || [];
      pages = data.pages || [];
    } catch (e) {
      console.error('Failed to load wiki data:', e);
      // Initialize with default data if loading fails
      initializeDefaultData();
    }
  } else {
    // Initialize with default data if no saved data exists
    initializeDefaultData();
  }
}

function initializeDefaultData() {
  // Start with empty collections and pages
  collections = [];
  pages = [];
}

function savePage() {
  const textarea = document.getElementById('editTextarea');
  const content = textarea?.value;
  if (!content) return;
  
  pages = pages.map(p => {
    if (p.id === state.activePageId) {
      return { ...p, content, updatedAt: Date.now() };
    }
    return p;
  });
  
  // Save to localStorage
  saveWikiData();
  
  // Show save notification
  showNotification('Page saved successfully!');
  
  state.editing = false;
  render();
}

function deletePage() {
  if (!confirm('Delete this page?')) return;
  pages = pages.filter(p => p.id !== state.activePageId);
  saveWikiData();
  state.activePageId = null;
  state.editing = false;
  render();
}

function insertWikiLink() {
  const textarea = document.getElementById('editTextarea');
  if (!textarea) return;
  
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selected = state.editContent.slice(start, end);
  const replacement = `[[${selected || 'Link Title'}]]`;
  
  state.editContent = state.editContent.slice(0, start) + replacement + state.editContent.slice(end);
  render();
  
  setTimeout(() => {
    textarea.focus();
    const newPos = start + replacement.length;
    textarea.setSelectionRange(newPos, newPos);
  }, 0);
}

// ─── MAIN RENDER ─────────────────────────────────────────────────────────────
function render() {
  renderSidebar();
  renderTopBar();
  renderMainContent();
}

// ─── EVENT LISTENERS ─────────────────────────────────────────────────────────
document.getElementById('searchInput').addEventListener('input', (e) => {
  state.searchQuery = e.target.value;
  render();
});

document.getElementById('allCollectionsBtn').addEventListener('click', () => {
  state.sidebarCollectionFilter = null;
  render();
});

document.getElementById('pagesTab').addEventListener('click', () => {
  state.activeTab = 'pages';
  if (graphState.animationFrame) cancelAnimationFrame(graphState.animationFrame);
  render();
});

document.getElementById('graphTab').addEventListener('click', () => {
  state.activeTab = 'graph';
  render();
});

document.getElementById('settingsTab').addEventListener('click', () => {
  state.activeTab = 'settings';
  render();
});

document.getElementById('newCollectionBtn').addEventListener('click', () => {
  state.creatingCollection = true;
  render();
});

// Mobile menu functionality
document.getElementById('mobileMenuBtn').addEventListener('click', () => {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
});

document.getElementById('sidebarOverlay').addEventListener('click', () => {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
});

// Close sidebar when clicking on a page item (mobile)
document.addEventListener('click', (e) => {
  if (window.innerWidth <= 768 && e.target.classList.contains('page-item')) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
  }
});

// ─── INIT ────────────────────────────────────────────────────────────────────
function loadSettings() {
  const saved = localStorage.getItem('seed-settings');
  if (saved) {
    try {
      const settings = JSON.parse(saved);
      state.appTitle = settings.appTitle || 'Seed';
      state.appSubtitle = settings.appSubtitle || 'Knowledge Capsule';
      state.currentTheme = settings.currentTheme || 'default';
      
      // Apply loaded settings
      document.getElementById('appTitle').textContent = state.appTitle;
      document.getElementById('appSubtitle').textContent = state.appSubtitle;
      document.title = `${state.appTitle} - ${state.appSubtitle}`;
      applyTheme(state.currentTheme);
    } catch (e) {
      console.error('Failed to load settings:', e);
    }
  }
}

loadSettings();
loadWikiData();
render();
</script>

</body>
</html>
